<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Sistema di Rilevazione Velocità Roblox</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css
<link href="favicon.png" rel="icon" type="image/x-icon"/>
<style>
    .log-entry {
      transition: all 0.3s ease;
    }
    .log-entry:hover {
      background-color: #f3f4f6;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .new-entry {
      animation: highlight 2s ease-out;
    }
    @keyframes highlight {
      0% { background-color: rgba(239, 68, 68, 0.2); }
      100% { background-color: transparent; }
    }
    .chart-container {
      height: 300px;
      position: relative;
    }
    .vehicle-chart-container {
  width: 70%;        /* Dimensione personalizzata per questo tipo di grafico */
  max-width: 450px;
  height: 250px;
  margin: 0 auto;
}
    .dark-mode {
      background-color: #1f2937;
      color: #2F4F4F;
    }
    .dark-mode .bg-white {
  background-color: #2d3748; /* Grigio scuro invece di bianco */
}

    .dark-mode .bg-white {
      background-color: #374151;
    }
    .dark-mode .bg-gray-50 {
      background-color: #4b5563;
    }
    .dark-mode .text-gray-800 {
      color: #f3f4f6;
    }
    .dark-mode .text-gray-700 {
      color: #e5e7eb;
    }
    .dark-mode .text-gray-600 {
      color: #d1d5db;
    }
    .dark-mode .text-gray-500 {
      color: #9ca3af;
    }
    .dark-mode .border {
      border-color: #4b5563;
    }
    .dark-mode .divide-y > * {
      border-color: #4b5563;
    }
    .dark-mode .log-entry:hover {
      background-color: #4b5563;
    }
    body {
 background-color: #f0f0f0;
}

  #vehicle-type-chart { max-height: 250px; }
#hourly-distribution-chart { max-height: 250px !important; }
</style>
</head>
<body class="bg-gray-100 min-h-screen">
<!-- Login Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="login-modal">
<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
<div class="flex justify-between items-center mb-4">
<h3 class="text-xl font-semibold text-gray-800">Accesso Sistema</h3>
</div>
<div class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" id="login-error"></div>
<div class="space-y-4 mb-6">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="username">Username</label>
<input class="w-full px-3 py-2 border rounded-md" id="username" placeholder="Inserisci username" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="password">Password</label>
<input class="w-full px-3 py-2 border rounded-md" id="password" placeholder="Inserisci password" type="password"/>
</div>
</div>
<div class="flex justify-end space-x-2">
<button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md" id="login-button">
        Accedi
      </button>
</div>
</div>
</div>
<!-- Admin Actions Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" id="admin-actions-modal">
<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
<div class="flex justify-between items-center mb-4">
<button class="text-gray-500 hover:text-gray-700" id="close-admin-modal">
<i class="fas fa-times"></i>
</button>
<h3 class="text-xl font-semibold text-gray-800">Pannello Amministratore</h3>
</div>
<div class="space-y-4 mb-6">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Elimina Dati</label>
<div class="flex items-center gap-2">
<select class="w-full px-3 py-2 border rounded-md" id="delete-option">
<option value="all">Tutti i dati</option>
<option value="older-than-month">Dati più vecchi di un mese</option>
<option value="older-than-week">Dati più vecchi di una settimana</option>
<option value="by-date">Dati per data specifica</option>
</select>
<input class="w-full px-3 py-2 border rounded-md hidden" id="delete-date" type="date"/>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Backup Dati</label>
<button class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md" id="backup-data">
          Esporta Backup
        </button>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Gestione Utenti</label>
<button class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md" id="manage-users">
          Gestisci Utenti
        </button>
</div>

</div>
<div class="border-t pt-4">
<button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md" id="execute-admin-action">
        Esegui Azione
      </button>
</div>
</div>
</div>
<!-- Manage Users Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" id="manage-users-modal">
<div class="bg-white rounded-lg shadow-lg p-6 max-w-xl w-full">
<div class="flex justify-between items-center mb-4">
<h3 class="text-xl font-semibold text-gray-800">Gestione Utenti</h3>
    <button class="text-gray-500 hover:text-gray-700" id="close-users-modal">
<i class="fas fa-times"></i>
</button>
</div>

<div class="space-y-4 mb-6">
<div>
<h4 class="font-medium text-gray-700 mb-2">Utenti Registrati</h4>
<div class="border rounded-md max-h-64 overflow-y-auto divide-y" id="users-list">
<!-- Gli utenti verranno inseriti qui -->
</div>
</div>

</div>
<div class="flex justify-between pt-4">

<button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md" id="save-users">
        Salva Modifiche
      </button>
</div>
</div>
</div>
<div class="container mx-auto px-4 py-8">
<header class="mb-6">
<div class="flex justify-between items-center">
<h1 class="text-3xl font-bold text-gray-800">Sistema di Rilevazione Velocità Roblox</h1>
<div class="header-buttons flex space-x-2">
<button class="bg-gray-800 text-white rounded-full p-2" id="dark-mode-toggle">
<i class="fas fa-moon"></i>
</button>
<button class="bg-blue-500 text-white rounded-full p-2" id="settings-button">
<i class="fas fa-cog"></i>
</button>
</div>
</div>
<p class="text-gray-600">Monitoraggio in tempo reale dei veicoli che superano i limiti di velocità</p>
<a href="monitorgomme.html"  class="bg-blue-500 text-white rounded-full p-2 inline-block">
  <i class="fas fa-tire" id="gomma"></i>
</a>
</header>
<!-- Pannello di controllo -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-semibold text-gray-800">Pannello di Controllo</h2>
<div class="flex items-center space-x-4">
<div class="flex items-center space-x-2">
<span class="inline-block w-3 h-3 bg-gray-400 rounded-full" id="status-indicator"></span>
<span id="connection-status">Connessione in corso...</span>
</div>
<button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex items-center" id="refresh-button">
<i class="fas fa-sync-alt mr-2"></i> Aggiorna
          </button>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
<div class="bg-blue-50 p-4 rounded-lg">
<p class="text-blue-500 font-medium">Rilevazioni Totali</p>
<p class="text-2xl font-bold" id="total-detections">0</p>
<p class="text-sm text-gray-500">Numero totale di superamenti</p>
</div>
<div class="bg-red-50 p-4 rounded-lg">
<p class="text-red-500 font-medium">Velocità Massima</p>
<p class="text-2xl font-bold" id="highest-speed">0 km/h</p>
<p class="text-sm text-gray-500">Rilevazione più alta</p>
</div>
<div class="bg-green-50 p-4 rounded-lg">
<p class="text-green-500 font-medium">Eccesso Medio</p>
<p class="text-2xl font-bold" id="average-excess">0 km/h</p>
<p class="text-sm text-gray-500">Media degli eccessi</p>
</div>
<div class="bg-yellow-50 p-4 rounded-lg">
<p class="text-yellow-500 font-medium">Rilevazioni Oggi</p>
<p class="text-2xl font-bold" id="detections-today">0</p>
<p class="text-sm text-gray-500">Superamenti delle ultime 24h</p>
</div>
</div>
</div>
<!-- Grafico -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
<h2 class="text-xl font-semibold text-gray-800 mb-4">Andamento Rilevazioni</h2>
<div class="chart-container">
<canvas id="speed-chart"></canvas>
</div>
</div>
<!-- Grafico per tipo di veicolo -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
<h2 class="text-xl font-semibold text-gray-800 mb-4">Distribuzione Tipi di Veicolo</h2>
<div class="vehicle-chart-container">
<canvas id="vehicle-type-chart"></canvas>
</div>
</div>
<!-- Grafico per distribuzione oraria -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
<h2 class="text-xl font-semibold text-gray-800 mb-4">Distribuzione Oraria Rilevazioni</h2>
<div class="chart-container">
<canvas id="hourly-distribution-chart"></canvas>
</div>
</div>
<!-- Filtri di ricerca -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
<h2 class="text-xl font-semibold text-gray-800 mb-4">Filtri di Ricerca</h2>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="vehicle-filter">Veicolo</label>
<input class="w-full px-3 py-2 border rounded-md" id="vehicle-filter" placeholder="Filtra per veicolo..." type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="min-speed">Velocità Minima</label>
<input class="w-full px-3 py-2 border rounded-md" id="min-speed" placeholder="Km/h" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="max-speed">Velocità Massima</label>
<input class="w-full px-3 py-2 border rounded-md" id="max-speed" placeholder="Km/h" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="date-filter">Data</label>
<input class="w-full px-3 py-2 border rounded-md" id="date-filter" type="date"/>
</div>
<div>
  <label class="block text-sm font-medium text-gray-700 mb-1" for="zone-filter">Zona</label>
  <input class="w-full px-3 py-2 border rounded-md" id="zone-filter" placeholder="Es. Zona 1" type="text"/>
</div>
</div>
<div class="flex justify-end">
<button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md mr-2" id="apply-filters">
          Applica Filtri
        </button>
<button class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md" id="reset-filters">
          Reimposta
        </button>
</div>
</div>
<!-- Tabella dei log -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-semibold text-gray-800">Log Rilevazioni</h2>
<div class="flex items-center space-x-2">
<span class="text-sm text-gray-500" id="filtered-count">Mostra tutti i risultati</span>
<select class="border rounded-md px-2 py-1" id="logs-per-page">
<option value="10">10 per pagina</option>
<option value="25">25 per pagina</option>
<option value="50">50 per pagina</option>
<option value="100">100 per pagina</option>
</select>
<button class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md flex items-center" id="export-csv">
<i class="fas fa-download mr-1"></i> CSV
          </button>
</div>
</div>
<div class="border rounded-lg overflow-hidden">
<div class="bg-gray-50 p-3 flex font-medium text-sm text-gray-700">
<div class="w-1/12">#</div>
<div class="w-1/6">Ora</div>
<div class="w-1/4">Veicolo</div>
<div class="w-1/6">Velocità</div>
<div class="w-1/6">Eccesso</div>
<div class="w-1/6">Data</div>
<div class="w-1/12">Circuito</div>
</div>
<div class="divide-y overflow-auto" id="logs-container" style="max-height: 500px; min-height: 300px;">
<!-- I log verranno inseriti qui -->
<div class="text-center text-gray-500 py-12">In attesa di rilevazioni...</div>
</div>
</div>
<!-- Paginazione -->
<div class="flex justify-between items-center mt-4">
<span class="text-sm text-gray-500" id="showing-entries">Mostra 0-0 di 0 risultati</span>
<div class="flex space-x-1">
<button class="px-3 py-1 border rounded-md disabled:opacity-50" id="prev-page">
<i class="fas fa-chevron-left"></i>
</button>
<div class="flex space-x-1" id="pagination-numbers">
<!--             <!-- I numeri di pagina verranno inseriti qui -->
</div>
<button class="px-3 py-1 border rounded-md disabled:opacity-50" id="next-page">
<i class="fas fa-chevron-right"></i>
</button>
</div>
</div>
</div>
<!-- Sezione Impostazioni (Modale) -->
<div class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" id="settings-modal">
<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
<div class="flex justify-between items-center mb-4">
<h3 class="text-xl font-semibold text-gray-800">Impostazioni</h3>
<button class="text-gray-500 hover:text-gray-700" id="close-settings">
<i class="fas fa-times"></i>
</button>
</div>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Intervallo di Aggiornamento</label>
<select class="w-full px-3 py-2 border rounded-md" id="poll-interval">
<option value="1000">1 secondo</option>
<option selected="" value="3000">3 secondi</option>
<option value="5000">5 secondi</option>
<option value="10000">10 secondi</option>
<option value="30000">30 secondi</option>
</select>
</div>
<div>
<label class="flex items-center space-x-2">
<input class="rounded" id="enable-sound" type="checkbox"/>
<span class="text-sm font-medium text-gray-700">Attiva notifiche sonore</span>
</label>
</div>
<div>
<label class="flex items-center space-x-2">
<input checked="" class="rounded" id="auto-scroll" type="checkbox"/>
<span class="text-sm font-medium text-gray-700">Scorri automaticamente ai nuovi log</span>
</label>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Limite minimo di visualizzazione</label>
<div class="flex items-center space-x-2">
<input class="w-full" id="min-display-speed" max="200" min="0" type="range" value="80"/>
<span id="min-display-speed-value">80 km/h</span>
</div>
</div>
</div>
<div class="mt-6 flex justify-end space-x-2">
<button class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md" id="reset-settings">
            Reimposta Default
          </button>
<button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md" id="save-settings">
            Salva Impostazioni
          </button>
</div>
</div>
</div>
</div>
<!-- Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
// Configurazione
const API_URL = 'https://irfradmin.netlify.app/.netlify/functions/api';
let POLL_INTERVAL = 3000; // Predefinito: 3 secondi
// Aggiungi queste variabili all'inizio dello script
let currentUser = null;
let isAdmin = false;
let users = [];

// Funzioni per il sistema di autenticazione
function initAuth() {
  // Carica gli utenti dal localStorage o crea un utente admin predefinito
  const storedUsers = localStorage.getItem('speedSystemUsers');
  if (storedUsers) {
    users = JSON.parse(storedUsers);
  } else {
    // Crea un utente admin predefinito se non esistono utenti
    users = [
      {
        username: 'Pietrolki',
        password: 'admin1212', // In produzione usare una password più sicura
        role: 'admin'
      },
      {
        username: 'IRFR',
        password: 'formula1',
        role: 'user'
      }
    ];
    localStorage.setItem('speedSystemUsers', JSON.stringify(users));
  }

  // Controlla se l'utente è già loggato
  const loggedInUser = sessionStorage.getItem('currentUser');
  if (loggedInUser) {
    currentUser = JSON.parse(loggedInUser);
    isAdmin = currentUser.role === 'admin';
    showLoggedInUI();
  } else {
    // Mostra il modale di login
    document.getElementById('login-modal').classList.remove('hidden');
  }
  
  // Attiva dark mode di default
  if (localStorage.getItem('darkMode') === null) {
    localStorage.setItem('darkMode', 'true');
    document.body.classList.add('dark-mode');
    if (darkModeToggle) {
      darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }
    document.documentElement.style.setProperty('--text-color', '#ffffff');
  } else if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
    if (darkModeToggle) {
      darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }
    document.documentElement.style.setProperty('--text-color', '#ffffff');
  }
}

// Login
function login(username, password) {
  const user = users.find(u => u.username === username && u.password === password);
  if (user) {
    currentUser = {
      username: user.username,
      role: user.role
    };
    isAdmin = user.role === 'admin';
    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
    document.getElementById('login-modal').classList.add('hidden');
    
    showLoggedInUI();
    return true;
  } else {
    document.getElementById('login-error').classList.remove('hidden');
    document.getElementById('login-error').textContent = 'Username o password non validi';
    return false;
  }
}

// Logout
function logout() {
  currentUser = null;
  isAdmin = false;
  sessionStorage.removeItem('currentUser');
  document.getElementById('login-modal').classList.remove('hidden');
  hideLoggedInUI();
}

// Mostra UI dopo il login
function showLoggedInUI() {
  // Aggiungi un elemento per mostrare l'utente corrente e il pulsante di logout
  const header = document.querySelector('header');
  
  // Crea elemento per utente se non esiste
  if (!document.getElementById('user-info')) {
    const userInfoDiv = document.createElement('div');
    userInfoDiv.id = 'user-info';
    userInfoDiv.className = 'flex items-center mt-4 justify-between';
    
    const userSpan = document.createElement('span');
    userSpan.className = 'text-sm text-gray-700';
    userSpan.textContent = `Accesso effettuato come: ${currentUser.username} (${currentUser.role === 'admin' ? 'Amministratore' : 'Utente'})`;
    
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'flex space-x-2';
    
    if (isAdmin) {
      const adminButton = document.createElement('button');
      adminButton.id = 'admin-panel-button';
      adminButton.className = 'bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm';
      adminButton.innerHTML = '<i class="fas fa-shield-alt mr-1"></i> Pannello Admin';
      adminButton.addEventListener('click', () => {
        document.getElementById('admin-actions-modal').classList.remove('hidden');
      });
      buttonsDiv.appendChild(adminButton);
    }
    
    const logoutButton = document.createElement('button');
    logoutButton.id = 'logout-button';
    logoutButton.className = 'bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md text-sm';
    logoutButton.innerHTML = '<i class="fas fa-sign-out-alt mr-1"></i> Logout';
    logoutButton.addEventListener('click', logout);
    
    buttonsDiv.appendChild(logoutButton);
    userInfoDiv.appendChild(userSpan);
    userInfoDiv.appendChild(buttonsDiv);
    
    header.appendChild(userInfoDiv);
  }
}

// Nascondi UI utente dopo logout
function hideLoggedInUI() {
  const userInfo = document.getElementById('user-info');
  if (userInfo) {
    userInfo.remove();
  }
}

// Gestione utenti
function renderUsersList() {
  const usersList = document.getElementById('users-list');
  usersList.innerHTML = '';
  
  users.forEach((user, index) => {
    const userRow = document.createElement('div');
    userRow.className = 'p-3 flex justify-between items-center';
    userRow.innerHTML = `
      <div>
        <span class="font-medium">${user.username}</span>
        <span class="ml-2 text-xs ${user.role === 'admin' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'} px-2 py-1 rounded">
          ${user.role === 'admin' ? 'Admin' : 'Utente'}
        </span>
      </div>
      <div class="flex space-x-2">
        <button class="change-password-btn text-blue-500 hover:text-blue-700" data-index="${index}">
          <i class="fas fa-key"></i> Cambia Password
        </button>
      </div>
    `;
    usersList.appendChild(userRow);
  });
  
  // Aggiungi event listeners ai pulsanti
  document.querySelectorAll('.change-password-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const index = e.currentTarget.dataset.index;
      const user = users[index];
      
      const newPassword = prompt(`Inserisci la nuova password per ${user.username}:`);
      if (newPassword && newPassword.length >= 6) {
        users[index].password = newPassword;
        localStorage.setItem('speedSystemUsers', JSON.stringify(users));
        alert(`Password aggiornata per ${user.username}`);
      } else if (newPassword) {
        alert('La password deve essere di almeno 6 caratteri');
      }
    });
  });
}

// Aggiungi nuovo utente
function addUser(username, password, role) {
  if (!username || !password) {
    alert('Username e password sono obbligatori');
    return false;
  }
  
  // Controlla se l'username esiste già
  if (users.some(u => u.username === username)) {
    alert('Username già esistente');
    return false;
  }
  
  // Aggiungi il nuovo utente
  users.push({
    username,
    password,
    role
  });
  
  // Salva nel localStorage
  localStorage.setItem('speedSystemUsers', JSON.stringify(users));
  
  // Aggiorna la lista utenti
  renderUsersList();
  
  return true;
}

// Funzioni per la persistenza dei dati
function saveLogsToStorage() {
  localStorage.setItem('speedSystemLogs', JSON.stringify(logs));
}

function loadLogsFromStorage() {
  const storedLogs = localStorage.getItem('speedSystemLogs');
  if (storedLogs) {
    logs = JSON.parse(storedLogs);
    
    // Aggiorna l'ultimo ID log
    if (logs.length > 0) {
      lastLogId = Math.max(...logs.map(log => log.id));
      
      // Aggiorna le statistiche
      logs.forEach(log => {
        statsData.totalDetections++;
        statsData.highestSpeed = Math.max(statsData.highestSpeed, log.speed);
        statsData.totalExcess += log.excess;
        
        if (isToday(log.timestamp)) {
          statsData.detectionsToday++;
        }
        
        // Aggiorna i dati del grafico (solo gli ultimi 20)
        if (logs.length <= 20) {
          const time = new Date(log.timestamp);
          speedData.labels.push(formatTime(time));
          speedData.speeds.push(log.speed);
        }
      });
      
      // Se ci sono più di 20 log, prendi gli ultimi 20 per il grafico
      if (logs.length > 20) {
        const recentLogs = logs.slice(-20);
        recentLogs.forEach(log => {
          const time = new Date(log.timestamp);
          speedData.labels.push(formatTime(time));
          speedData.speeds.push(log.speed);
        });
      }
      
      // Aggiorna le statistiche
      updateStats();
      
      // Aggiorna il grafico
      updateChart();
    }
    
    // Ordina i log per data più recente
    logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    filteredLogs = [...logs];
    renderLogs();
  }
}

// Funzioni di amministrazione
function executeAdminAction() {
  const actionType = document.getElementById('delete-option').value;
  
  if (actionType === 'all') {
    if (confirm('Sei sicuro di voler eliminare TUTTI i dati? Questa azione non può essere annullata.')) {
      logs = [];
      saveLogsToStorage();
      resetStats();
      applyFilters();
      alert('Tutti i dati sono stati eliminati');
    }
  } else if (actionType === 'older-than-month') {
    const oneMonthAgo = new Date();
    oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
    
    const filteredOut = logs.filter(log => new Date(log.timestamp) < oneMonthAgo);
    if (filteredOut.length === 0) {
      alert('Non ci sono dati più vecchi di un mese');
      return;
    }
    
    if (confirm(`Stai per eliminare ${filteredOut.length} rilevazioni più vecchie di un mese. Confermi?`)) {
      logs = logs.filter(log => new Date(log.timestamp) >= oneMonthAgo);
      saveLogsToStorage();
      recalculateStats();
      applyFilters();
      alert(`${filteredOut.length} rilevazioni sono state eliminate`);
    }
  } else if (actionType === 'older-than-week') {
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    
    const filteredOut = logs.filter(log => new Date(log.timestamp) < oneWeekAgo);
    if (filteredOut.length === 0) {
      alert('Non ci sono dati più vecchi di una settimana');
      return;
    }
    
    if (confirm(`Stai per eliminare ${filteredOut.length} rilevazioni più vecchie di una settimana. Confermi?`)) {
      logs = logs.filter(log => new Date(log.timestamp) >= oneWeekAgo);
      saveLogsToStorage();
      recalculateStats();
      applyFilters();
      alert(`${filteredOut.length} rilevazioni sono state eliminate`);
    }
  } else if (actionType === 'by-date') {
    const selectedDate = document.getElementById('delete-date').value;
    if (!selectedDate) {
      alert('Seleziona una data');
      return;
    }
    
    const startOfDay = new Date(selectedDate);
    const endOfDay = new Date(selectedDate);
    endOfDay.setHours(23, 59, 59, 999);
    
    const filteredOut = logs.filter(log => {
      const logDate = new Date(log.timestamp);
      return logDate >= startOfDay && logDate <= endOfDay;
    });
    
    if (filteredOut.length === 0) {
      alert(`Non ci sono dati per la data ${selectedDate}`);
      return;
    }
    
    if (confirm(`Stai per eliminare ${filteredOut.length} rilevazioni del ${selectedDate}. Confermi?`)) {
      logs = logs.filter(log => {
        const logDate = new Date(log.timestamp);
        return !(logDate >= startOfDay && logDate <= endOfDay);
      });
      saveLogsToStorage();
      recalculateStats();
      applyFilters();
      alert(`${filteredOut.length} rilevazioni sono state eliminate`);
    }
  }
}

// Ricalcola le statistiche dopo eliminazione di dati
function recalculateStats() {
  statsData = {
    totalDetections: logs.length,
    highestSpeed: 0,
    totalExcess: 0,
    detectionsToday: 0
  };
  
  logs.forEach(log => {
    statsData.highestSpeed = Math.max(statsData.highestSpeed, log.speed);
    statsData.totalExcess += log.excess;
    
    if (isToday(log.timestamp)) {
      statsData.detectionsToday++;
    }
  });
  
  // Aggiorna il grafico
  speedData = {
    labels: [],
    speeds: []
  };
  
  // Prendi gli ultimi 20 log per il grafico
  const recentLogs = logs.slice(-20);
  recentLogs.forEach(log => {
    const time = new Date(log.timestamp);
    speedData.labels.push(formatTime(time));
    speedData.speeds.push(log.speed);
  });
  
  updateStats();
  updateChart();
}

function resetStats() {
  statsData = {
    totalDetections: 0,
    highestSpeed: 0,
    totalExcess: 0,
    detectionsToday: 0
  };
  
  speedData = {
    labels: [],
    speeds: []
  };
  
  updateStats();
  updateChart();
}

// Esporta backup dei dati
function exportBackup() {
  const backupData = {
    logs,
    statsData,
    appSettings
  };
  
  const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.setAttribute('href', url);
  link.setAttribute('download', `speed-system-backup-${formatDate(new Date())}.json`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Aggiunta all'inizializzazione
window.addEventListener('load', () => {
  loadSettings();
  initAuth();
 // loadLogsFromStorage();
  
  // Interval per il salvataggio automatico dei dati
  setInterval(saveLogsToStorage, 60000); // Salva ogni minuto
  
  fetchLogs();
  updateChart();
  
  // Aggiungi la gestione del limite di velocità alla sezione filtri
  addSpeedLimitToFilters();
});

// Modificare la funzione fetchLogs

// Event listeners per il sistema di login
document.getElementById('login-button').addEventListener('click', () => {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  login(username, password);
});

// Event listener per admin actions
document.getElementById('delete-option').addEventListener('change', (e) => {
  const dateInput = document.getElementById('delete-date');
  if (e.target.value === 'by-date') {
    dateInput.classList.remove('hidden');
  } else {
    dateInput.classList.add('hidden');
  }
});

document.getElementById('close-admin-modal').addEventListener('click', () => {
  document.getElementById('admin-actions-modal').classList.add('hidden');
});

document.getElementById('execute-admin-action').addEventListener('click', executeAdminAction);

document.getElementById('backup-data').addEventListener('click', exportBackup);

document.getElementById('manage-users').addEventListener('click', () => {
  document.getElementById('admin-actions-modal').classList.add('hidden');
  document.getElementById('manage-users-modal').classList.remove('hidden');
  renderUsersList();
});

document.getElementById('close-users-modal').addEventListener('click', () => {
  document.getElementById('manage-users-modal').classList.add('hidden');
});

const addUserBtn = document.getElementById('add-user');
if (addUserBtn) {
  addUserBtn.addEventListener('click', () => {
    const username = document.getElementById('new-username').value;
    const password = document.getElementById('new-password').value;
    const role = document.getElementById('new-role').value;

    if (addUser(username, password, role)) {
      document.getElementById('new-username').value = '';
      document.getElementById('new-password').value = '';
      document.getElementById('new-role').value = 'user';
    }
  });
}

// Stato
let logs = [];
let filteredLogs = [];
let lastLogId = 0;
let currentPage = 1;
let logsPerPage = 10;
let statsData = {
  totalDetections: 0,
  highestSpeed: 0,
  totalExcess: 0,
  detectionsToday: 0
};
let filterSettings = {
  vehicle: '',
  minSpeed: '',
  maxSpeed: '',
  date: '',
  zona: ''
};
let appSettings = {
  pollInterval: 3000,
  enableSound: false,
  autoScroll: true,
  minDisplaySpeed: 80
};
let chartInstance = null;
let speedData = {
  labels: [],
  speeds: []
};

// Elementi DOM
const logsContainer = document.getElementById('logs-container');
const statusIndicator = document.getElementById('status-indicator');
const connectionStatus = document.getElementById('connection-status');
const totalDetectionsEl = document.getElementById('total-detections');
const highestSpeedEl = document.getElementById('highest-speed');
const averageExcessEl = document.getElementById('average-excess');
const detectionsToday = document.getElementById('detections-today');
const showingEntries = document.getElementById('showing-entries');
const filteredCount = document.getElementById('filtered-count');
const paginationNumbers = document.getElementById('pagination-numbers');
const prevPageBtn = document.getElementById('prev-page');
const nextPageBtn = document.getElementById('next-page');

// Elementi filtri
const vehicleFilter = document.getElementById('vehicle-filter');
const minSpeedFilter = document.getElementById('min-speed');
const maxSpeedFilter = document.getElementById('max-speed');
const dateFilter = document.getElementById('date-filter');
const zoneFilter = document.getElementById('zone-filter');
const applyFiltersBtn = document.getElementById('apply-filters');
const resetFiltersBtn = document.getElementById('reset-filters');

// Elementi impostazioni
const settingsModal = document.getElementById('settings-modal');
const settingsButton = document.getElementById('settings-button');
const closeSettings = document.getElementById('close-settings');
const pollIntervalSelect = document.getElementById('poll-interval');
const enableSoundCheckbox = document.getElementById('enable-sound');
const autoScrollCheckbox = document.getElementById('auto-scroll');
const minDisplaySpeedSlider = document.getElementById('min-display-speed');
const minDisplaySpeedValue = document.getElementById('min-display-speed-value');
const saveSettingsBtn = document.getElementById('save-settings');
const resetSettingsBtn = document.getElementById('reset-settings');

// Altri elementi
const refreshButton = document.getElementById('refresh-button');
const exportCsvBtn = document.getElementById('export-csv');
const logsPerPageSelect = document.getElementById('logs-per-page');
const darkModeToggle = document.getElementById('dark-mode-toggle');
// Aggiungere all'inizio del file dopo il DOMContentLoaded
async function verifyApiConnection() {
  const statusElement = document.getElementById('status-indicator') || 
                       document.getElementById('connection-status-indicator');
  const statusTextElement = document.getElementById('connection-status');
  
  try {
    const apiUrl = 'https://irfradmin.netlify.app/.netlify/functions/api?type=ping';
    const response = await fetch(apiUrl, { method: 'OPTIONS' });
    
    if (response.ok || response.status === 204) {
      console.log('API connessa correttamente');
      if (statusElement) statusElement.className = 'inline-block w-3 h-3 bg-green-500 rounded-full';
      if (statusTextElement) statusTextElement.textContent = 'API connessa';
      return true;
    } else {
      throw new Error(`API ha risposto con stato ${response.status}`);
    }
  } catch (error) {
    console.error('Errore di connessione all\'API:', error);
    if (statusElement) statusElement.className = 'inline-block w-3 h-3 bg-red-500 rounded-full';
    if (statusTextElement) statusTextElement.textContent = 'API non raggiungibile';
    return false;
  }
}

// Chiamare questa funzione all'avvio
verifyApiConnection();
// Funzioni di utilità
function formatTime(date) {
  return date.toTimeString().split(' ')[0];
}

function formatDate(date) {
  return date.toISOString().split('T')[0];
}

function isToday(dateStr) {
  const today = new Date();
  const date = new Date(dateStr);
  return date.getDate() === today.getDate() &&
         date.getMonth() === today.getMonth() &&
         date.getFullYear() === today.getFullYear();
}

// Funzione per aggiungere la gestione del limite di velocità ai filtri
function addSpeedLimitToFilters() {
  const filtersContainer = document.querySelector('.filters-container');
  if (!filtersContainer) return;
  
  // Crea il container per il limite di velocità
  const speedLimitContainer = document.createElement('div');
  speedLimitContainer.className = 'mb-4';
  speedLimitContainer.innerHTML = `
    <h3 class="text-lg font-medium mb-2">Limite di velocità</h3>
    <div class="flex space-x-2">
      <div class="w-1/2">
        <label class="block text-sm font-medium mb-1" for="zone-select">Zona</label>
        <select id="zone-select" class="w-full rounded-md border-gray-300 shadow-sm">
          <option value="1">Zona 1 - Urbana</option>
          <option value="2">Zona 2 - Extraurbana</option>
          <option value="3">Zona 3 - Autostrada</option>
        </select>
      </div>
      <div class="w-1/2">
        <label class="block text-sm font-medium mb-1" for="speed-limit">Limite (km/h)</label>
        <input type="number" id="speed-limit" class="w-full rounded-md border-gray-300 shadow-sm" min="20" max="150" value="50">
      </div>
    </div>
    <button id="save-speed-limit" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm">Salva limite</button>
  `;
  
  filtersContainer.appendChild(speedLimitContainer);
  
  // Carica le impostazioni salvate
  const speedLimits = JSON.parse(localStorage.getItem('speedLimits') || '{"1":50,"2":90,"3":130}');
  document.getElementById('speed-limit').value = speedLimits[document.getElementById('zone-select').value] || 50;
  
  // Aggiungi event listener per il cambio di zona
  document.getElementById('zone-select').addEventListener('change', (e) => {
    const zone = e.target.value;
    const speedLimits = JSON.parse(localStorage.getItem('speedLimits') || '{"1":50,"2":90,"3":130}');
    document.getElementById('speed-limit').value = speedLimits[zone] || 50;
  });
  
  // Aggiungi event listener per il salvataggio
  document.getElementById('save-speed-limit').addEventListener('click', () => {
    const newLimit = parseInt(document.getElementById('speed-limit').value);
    const zone = document.getElementById('zone-select').value;
    
    if (newLimit >= 20 && newLimit <= 150) {
      // Salva il nuovo limite di velocità
      const speedLimits = JSON.parse(localStorage.getItem('speedLimits') || '{}');
      speedLimits[zone] = newLimit;
      localStorage.setItem('speedLimits', JSON.stringify(speedLimits));
      
      // Aggiorna la visualizzazione
      const zoneText = document.getElementById('zone-select').options[document.getElementById('zone-select').selectedIndex].text;
      alert(`Limite di velocità per ${zoneText} impostato a ${newLimit} km/h`);
    } else {
      alert('Il limite deve essere tra 20 e 150 km/h');
    }
  });
}

// Crea un elemento di log con l'ordine modificato
function createLogEntry(log, index) {
  const logEntry = document.createElement('div');
  logEntry.className = 'log-entry flex p-3 text-sm items-center' + (log.isNew ? ' new-entry' : '');
  logEntry.dataset.id = log.id;
  
  const time = new Date(log.timestamp);
  const zona = log.zone || 'Circuito non identificato';
  
  logEntry.innerHTML = `
    <div class="w-1/12">${index}</div>
    <div class="w-1/6">${formatTime(time)}</div>
    <div class="w-1/6">${log.vehicleName}</div>
    <div class="w-1/6 font-medium">${log.speed} km/h</div>
    <div class="w-1/6 text-red-600">+${log.excess} km/h</div>
    <div class="w-1/6">${formatDate(time)}</div>
    <div class="w-1/6">${zona}</div>
  `;
  
  return logEntry;
}

// Aggiorna le statistiche
function updateStats() {
  totalDetectionsEl.textContent = statsData.totalDetections;
  highestSpeedEl.textContent = `${statsData.highestSpeed} km/h`;
  
  const avgExcess = statsData.totalDetections > 0 
    ? Math.round(statsData.totalExcess / statsData.totalDetections) 
    : 0;
  averageExcessEl.textContent = `${avgExcess} km/h`;
  detectionsToday.textContent = statsData.detectionsToday;
}

// Aggiorna il grafico
function updateChart() {
  if (chartInstance) {
    chartInstance.destroy();
  }
  
  const formattedLabels = speedData.labels.map((label, i) => {
    const logIndex = logs.length - speedData.labels.length + i;
    if (logIndex >= 0 && logs[logIndex]) {
      const date = new Date(logs[logIndex].timestamp);
      return `${date.toLocaleDateString()} ${label}`;
    }
    return label;
  });
  
  const ctx = document.getElementById('speed-chart').getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: formattedLabels,
      datasets: [{
        label: 'Velocità (km/h)',
        data: speedData.speeds,
        borderColor: 'rgb(59, 130, 246)',
        backgroundColor: 'rgba(59, 130, 246, 0.2)',
        borderWidth: 2,
        tension: 0.1,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'Andamento velocità - Ultime 20 rilevazioni',
          font: {
            size: 16
          }
        },
        tooltip: {
          callbacks: {
            title: function(tooltipItems) {
              return 'Rilevazione del ' + tooltipItems[0].label;
            }
          }
        },
        legend: {
          position: 'bottom'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Velocità (km/h)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Data e ora rilevazione'
          },
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        }
      }
    }
  });
}
    // Funzione per creare un grafico a torta per tipi di veicoli
function createVehicleTypeChart() {
  const vehicleTypes = {};
  logs.forEach(log => {
    // Estrai il tipo di veicolo (esempio: Auto, Moto, Camion, etc.)
    const type = log.vehicleName.split(' ')[0]; // Modifica in base alla tua logica
    vehicleTypes[type] = (vehicleTypes[type] || 0) + 1;
  });
  
  const colors = [
    'rgba(54, 162, 235, 0.8)',
    'rgba(255, 99, 132, 0.8)',
    'rgba(255, 206, 86, 0.8)',
    'rgba(75, 192, 192, 0.8)',
    'rgba(153, 102, 255, 0.8)'
  ];
  
  const ctx = document.getElementById('vehicle-type-chart').getContext('2d');
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: Object.keys(vehicleTypes),
      datasets: [{
        data: Object.values(vehicleTypes),
        backgroundColor: colors.slice(0, Object.keys(vehicleTypes).length)
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Distribuzione per tipo di veicolo'
        },
        legend: {
          position: 'bottom'
        }
      }
    }
  });
}

// Funzione per creare un grafico per fasce orarie
function createHourlyDistributionChart() {
  const hourlyData = Array(24).fill(0);
  
  logs.forEach(log => {
    const hour = new Date(log.timestamp).getHours();
    hourlyData[hour]++;
  });
  
  const ctx = document.getElementById('hourly-distribution-chart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Array.from({length: 24}, (_, i) => `${i}:00`),
      datasets: [{
        label: 'Numero rilevazioni',
        data: hourlyData,
        backgroundColor: 'rgba(75, 192, 192, 0.8)'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Distribuzione rilevazioni per ora del giorno'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Numero rilevazioni'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Ora del giorno'
          }
        }
      }
    }
  });
}



// Aggiungi questa chiamata alla tua funzione di inizializzazione
window.addEventListener('load', () => {
  loadSettings();
  fetchLogs();
  updateChart();
  
  // Aggiungi le nuove funzionalità
  createVehicleTypeChart();
  createHourlyDistributionChart();
});

// Aggiungi anche la chiamata quando aggiorni i log
function handleNewData() {
  // ... codice esistente ...
  createVehicleTypeChart();
  createHourlyDistributionChart();
}
    // Aggiungi questa funzione
function showSpeedLimitModal() {
  // Crea un modale se non esiste
  if (!document.getElementById('speed-limit-modal')) {
    const modal = document.createElement('div');
    modal.id = 'speed-limit-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
    modal.innerHTML = `
      <div class="bg-white rounded-lg p-6 w-96 shadow-xl">
        <h2 class="text-xl font-bold mb-4">Modifica limite di velocità</h2>
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2" for="speed-limit">
            Nuovo limite (km/h)
          </label>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                 id="speed-limit" type="number" min="20" max="150" value="50">
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2" for="zone-select">
            Zona
          </label>
          <select class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                  id="zone-select">
            <option value="1">Zona 1 - Urbana</option>
            <option value="2">Zona 2 - Extraurbana</option>
            <option value="3">Zona 3 - Autostrada</option>
          </select>
        </div>
        <div class="flex items-center justify-between">
          <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" 
                  id="save-speed-limit">
            Salva
          </button>
          <button class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" 
                  id="cancel-speed-limit">
            Annulla
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    
    // Aggiungi event listeners
    document.getElementById('save-speed-limit').addEventListener('click', () => {
      const newLimit = parseInt(document.getElementById('speed-limit').value);
      const zone = document.getElementById('zone-select').value;
      if (newLimit >= 20 && newLimit <= 150) {
        // Salva il nuovo limite di velocità
        const speedLimits = JSON.parse(localStorage.getItem('speedLimits') || '{}');
        speedLimits[zone] = newLimit;
        localStorage.setItem('speedLimits', JSON.stringify(speedLimits));
        
        // Aggiorna la visualizzazione
        const zoneText = document.getElementById('zone-select').options[document.getElementById('zone-select').selectedIndex].text;
        alert(`Limite di velocità per ${zoneText} impostato a ${newLimit} km/h`);
        document.getElementById('speed-limit-modal').classList.add('hidden');
      } else {
        alert('Il limite deve essere tra 20 e 150 km/h');
      }
    });
    
    document.getElementById('cancel-speed-limit').addEventListener('click', () => {
      document.getElementById('speed-limit-modal').classList.add('hidden');
    });
  }
  
  // Mostra il modale
  document.getElementById('speed-limit-modal').classList.remove('hidden');
}



    
    // Filtra i log in base ai criteri specificati
    function applyFilters() {
      filterSettings.vehicle = vehicleFilter.value.toLowerCase();
      filterSettings.minSpeed = parseInt(minSpeedFilter.value) || '';
      filterSettings.maxSpeed = parseInt(maxSpeedFilter.value) || '';
      filterSettings.date = dateFilter.value;
    filterSettings.zona = document.getElementById('zone-filter').value.toLowerCase();

      
      filteredLogs = logs.filter(log => {
        // Filtro veicolo
        if (filterSettings.vehicle && !log.vehicleName.toLowerCase().includes(filterSettings.vehicle)) {
          return false;
        }
        
        // Filtro velocità minima
        if (filterSettings.minSpeed !== '' && log.speed < filterSettings.minSpeed) {
          return false;
        }
        
        // Filtro velocità massima
        if (filterSettings.maxSpeed !== '' && log.speed > filterSettings.maxSpeed) {
          return false;
        }
        
        // Filtro data
        if (filterSettings.date && formatDate(new Date(log.timestamp)) !== filterSettings.date) {
          return false;
        }
        // Filtro zona
        if (filterSettings.zona && (!log.zone || !log.zone.toLowerCase().includes(filterSettings.zona))) {
              return false;
        }

        return true;
      });
      
      currentPage = 1;
      renderLogs();
    }
    
    // Reset dei filtri
    function resetFilters() {
      vehicleFilter.value = '';
      minSpeedFilter.value = '';
      maxSpeedFilter.value = '';
      dateFilter.value = '';
      zoneFilter.value = '';
      
      filterSettings.vehicle = '';
      filterSettings.minSpeed = '';
      filterSettings.maxSpeed = '';
      filterSettings.date = '';
      
      filteredLogs = [...logs];
      currentPage = 1;
      renderLogs();
    }
    
    // Esporta i log in formato CSV
    function exportToCsv() {
      const headers = ['ID', 'Data', 'Ora', 'Veicolo', 'Velocità (km/h)', 'Eccesso (km/h)'];
      
      const csvContent = [
        headers.join(','),
        ...filteredLogs.map(log => {
          const date = new Date(log.timestamp);
          return [
            log.id,
            formatDate(date),
            formatTime(date),
            `"${log.vehicleName}"`,
            log.speed,
            log.excess
          ].join(',');
        })
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `rilevazioni-velocita-${formatDate(new Date())}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Aggiorna la paginazione
    function updatePagination() {
      const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
      
      // Aggiorna i pulsanti prev/next
      prevPageBtn.disabled = currentPage === 1;
      nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
      
      // Aggiorna l'indicatore di pagine
      paginationNumbers.innerHTML = '';
      
      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);
      
      if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
      }
      
      if (startPage > 1) {
        const btn = document.createElement('button');
        btn.className = 'px-3 py-1 border rounded-md';
        btn.textContent = '1';
        btn.addEventListener('click', () => {
          currentPage = 1;
          renderLogs();
        });
        paginationNumbers.appendChild(btn);
        
        if (startPage > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'px-3 py-1';
          ellipsis.textContent = '...';
          paginationNumbers.appendChild(ellipsis);
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('button');
        btn.className = `px-3 py-1 border rounded-md ${i === currentPage ? 'bg-blue-500 text-white' : ''}`;
        btn.textContent = i;
        btn.addEventListener('click', () => {
          currentPage = i;
          renderLogs();
        });
        paginationNumbers.appendChild(btn);
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'px-3 py-1';
          ellipsis.textContent = '...';
          paginationNumbers.appendChild(ellipsis);
        }
        
        const btn = document.createElement('button');
        btn.className = 'px-3 py-1 border rounded-md';
        btn.textContent = totalPages;
        btn.addEventListener('click', () => {
          currentPage = totalPages;
          renderLogs();
        });
        paginationNumbers.appendChild(btn);
      }
      
      // Aggiorna l'indicatore di risultati
      const start = filteredLogs.length > 0 ? (currentPage - 1) * logsPerPage + 1 : 0;
      const end = Math.min(currentPage * logsPerPage, filteredLogs.length);
      showingEntries.textContent = `Mostra ${start}-${end} di ${filteredLogs.length} risultati`;
      
      if (filteredLogs.length < logs.length) {
        filteredCount.textContent = `Filtrati: ${filteredLogs.length} di ${logs.length} totali`;
      } else {
        filteredCount.textContent = `Mostra tutti i risultati (${logs.length})`;
      }
    }
    
    // Renderizza i log nella tabella
    function renderLogs() {
  console.log('Rendering logs:', logs);
      if (filteredLogs.length === 0) {
        logsContainer.innerHTML = '<div class="text-center text-gray-500 py-12">Nessun risultato trovato</div>';
      } else {
        logsContainer.innerHTML = '';
        
        const startIndex = (currentPage - 1) * logsPerPage;
        const endIndex = Math.min(startIndex + logsPerPage, filteredLogs.length);
        
        for (let i = startIndex; i < endIndex; i++) {
          const logElement = createLogEntry(filteredLogs[i], i + 1);
          logsContainer.appendChild(logElement);
        }
      }
      
      updatePagination();
    }
    
    // Salva le impostazioni
    function saveSettings() {
      appSettings.pollInterval = parseInt(pollIntervalSelect.value);
      appSettings.enableSound = enableSoundCheckbox.checked;
      appSettings.autoScroll = autoScrollCheckbox.checked;
      appSettings.minDisplaySpeed = parseInt(minDisplaySpeedSlider.value);
      
      POLL_INTERVAL = appSettings.pollInterval;
      
      localStorage.setItem('speedDetectionSettings', JSON.stringify(appSettings));
      
      settingsModal.classList.add('hidden');
    }
    
    // Reimposta le impostazioni ai valori predefiniti
    function resetSettings() {
      
      pollIntervalSelect.value = appSettings.pollInterval;
      enableSoundCheckbox.checked = appSettings.enableSound;
      autoScrollCheckbox.checked = appSettings.autoScroll;
      minDisplaySpeedSlider.value = appSettings.minDisplaySpeed;
      minDisplaySpeedValue.textContent = `${appSettings.minDisplaySpeed} km/h`;
      
      POLL_INTERVAL = appSettings.pollInterval;
    }
    // Aggiungi questo nella sezione di stile o in un tag <style>
document.body.classList.contains('dark-mode') ? 
  document.documentElement.style.setProperty('--text-color', '#ffffff') : 
  document.documentElement.style.setProperty('--text-color', '#333333');

// Aggiorna la funzione toggleDarkMode
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
  
  if (document.body.classList.contains('dark-mode')) {
    darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    document.documentElement.style.setProperty('--text-color', '#ffffff');
    // Aggiorna anche i colori delle tabelle e altri elementi
    document.querySelectorAll('.log-entry').forEach(entry => {
      entry.classList.add('dark-text');
    });
  } else {
    darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
    document.documentElement.style.setProperty('--text-color', '#333333');
    document.querySelectorAll('.log-entry').forEach(entry => {
      entry.classList.remove('dark-text');
    });
  }
}

    // Fetch dei log
    async function fetchLogs() {
  try {
    statusIndicator.className = 'inline-block w-3 h-3 bg-yellow-400 rounded-full';
    connectionStatus.textContent = 'Recupero dati...';

    // Correzione 1: Usa l'URL completo e specifica esplicitamente type=speed
    const url = lastLogId 
      ? `https://irfradmin.netlify.app/.netlify/functions/api?since=${lastLogId}&type=speed` 
      : `${API_URL}?type=speed`;
      
    const response = await fetch(url);

    if (!response.ok) throw new Error('Errore di rete');

    const newLogs = await response.json();

    if (newLogs.length > 0) {
      // Il resto della funzione può rimanere invariato
      // perché gestisce già correttamente i campi necessari
      const existingIds = new Set(logs.map(log => log.id));
      const uniqueNewLogs = newLogs.filter(log => !existingIds.has(log.id));
      
      if (uniqueNewLogs.length > 0) {
        lastLogId = Math.max(...uniqueNewLogs.map(log => log.id));
        uniqueNewLogs.forEach(log => {
          log.isNew = true;
          log.zone = log.zone || 'Circuito non identificato';
          statsData.totalDetections++;
          statsData.highestSpeed = Math.max(statsData.highestSpeed, log.speed);
          statsData.totalExcess += log.excess;
          if (isToday(log.timestamp)) statsData.detectionsToday++;
          const time = new Date(log.timestamp);
          speedData.labels.push(formatTime(time));
          speedData.speeds.push(log.speed);
          if (speedData.labels.length > 20) {
            speedData.labels.shift();
            speedData.speeds.shift();
          }
        });

        logs = [...uniqueNewLogs]; // ✅ sovrascrive tutto
filteredLogs = [...logs]; // ✅ aggiorna i dati filtrati
logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
saveLogsToStorage();
        applyFilters();
        updateChart();
        updateStats();
      }
    }
    
    statusIndicator.className = 'inline-block w-3 h-3 bg-green-400 rounded-full';
    connectionStatus.textContent = 'Connesso';
  } catch (error) {
    console.error('Errore nel recupero dei log:', error);
    statusIndicator.className = 'inline-block w-3 h-3 bg-red-500 rounded-full';
    connectionStatus.textContent = 'Errore di connessione';
  }

  setTimeout(fetchLogs, POLL_INTERVAL);
}
    // Event listeners
    applyFiltersBtn.addEventListener('click', applyFilters);
    resetFiltersBtn.addEventListener('click', resetFilters);
    prevPageBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderLogs();
      }
    });
    nextPageBtn.addEventListener('click', () => {
      const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderLogs();
      }
    });
    
    logsPerPageSelect.addEventListener('change', () => {
      logsPerPage = parseInt(logsPerPageSelect.value);
      currentPage = 1;
      renderLogs();
    });
    
    exportCsvBtn.addEventListener('click', exportToCsv);
    refreshButton.addEventListener('click', () => {
      fetchLogs();
    });
    
    settingsButton.addEventListener('click', () => {
      settingsModal.classList.remove('hidden');
    });
    
    closeSettings.addEventListener('click', () => {
      settingsModal.classList.add('hidden');
    });
    
    saveSettingsBtn.addEventListener('click', saveSettings);
    resetSettingsBtn.addEventListener('click', resetSettings);
    
    darkModeToggle.addEventListener('click', toggleDarkMode);
    
    minDisplaySpeedSlider.addEventListener('input', () => {
      minDisplaySpeedValue.textContent = `${minDisplaySpeedSlider.value} km/h`;
    });
    
    // Event delegation per i dettagli dei log
    logsContainer.addEventListener('click', (e) => {
      if (e.target.closest('.detail-btn')) {
        const id = parseInt(e.target.closest('.detail-btn').dataset.id);
        const log = logs.find(l => l.id === id);
        
        if (log) {
          alert(`Dettagli Rilevazione #${log.id}:
Veicolo: ${log.vehicleName}
Velocità: ${log.speed} km/h
Eccesso: +${log.excess} km/h
Data e ora: ${new Date(log.timestamp).toLocaleString()}`);
        }
      }
    });
    
    // Carica le impostazioni salvate
    function loadSettings() {
      const savedSettings = localStorage.getItem('speedDetectionSettings');
      
      if (savedSettings) {
        appSettings = JSON.parse(savedSettings);
        
        pollIntervalSelect.value = appSettings.pollInterval;
        enableSoundCheckbox.checked = appSettings.enableSound;
        autoScrollCheckbox.checked = appSettings.autoScroll;
        minDisplaySpeedSlider.value = appSettings.minDisplaySpeed;
        minDisplaySpeedValue.textContent = `${appSettings.minDisplaySpeed} km/h`;
        
        POLL_INTERVAL = appSettings.pollInterval;
      }
    }
    
    // Inizializzazione
    window.addEventListener('load', () => {
      localStorage.removeItem('speedSystemLogs');
      loadSettings();
      fetchLogs();
      filteredLogs = [...logs];
      updateChart();
    });
  </script>
</body>
</html>
